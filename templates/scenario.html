{% extends "base.html" %}

{% block title %}Scenario & Data - Daily EMS Sandbox{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<!-- Leaflet JS - Load in head to ensure it's available -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
<style>
    #map { 
        height: 400px; 
        width: 100%; 
        z-index: 0;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        background-color: #e9ecef;
    }
    .leaflet-container {
        height: 100%;
        width: 100%;
        font-family: inherit;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex align-items-center mb-4">
        <div class="me-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; font-weight: 700;">
                1
            </div>
        </div>
        <div>
            <h1 class="mb-0">Scenario & Data</h1>
            <p class="text-muted mb-0">Configure your scenario parameters and location</p>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-calendar-range me-2"></i>Choose period and selected date</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="periodStart" class="form-label">Period start</label>
                    <input type="date" class="form-control" id="periodStart" value="{{ period_start }}">
                </div>
                <div class="col-md-4">
                    <label for="periodEnd" class="form-label">Period end</label>
                    <input type="date" class="form-control" id="periodEnd" value="{{ period_end }}">
                </div>
                <div class="col-md-4">
                    <label for="selectedDay" class="form-label">Selected day for analysis</label>
                    <input type="date" class="form-control" id="selectedDay" value="{{ selected_day }}">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Location Selection</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label for="locationDropdown" class="form-label">Choose city</label>
                    <select class="form-select mb-3" id="locationDropdown">
                        <option value="Aalborg">Aalborg (DK1)</option>
                        <option value="Aarhus">Aarhus (DK1)</option>
                        <option value="Odense">Odense (DK1)</option>
                        <option value="Copenhagen">Copenhagen (DK2)</option>
                        <option value="Custom">Custom</option>
                    </select>
                    
                    <div id="customLocationFields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="latitude" class="form-label">Latitude</label>
                                <input type="number" class="form-control" id="latitude" step="0.0001" value="57.0488">
                            </div>
                            <div class="col-md-6">
                                <label for="longitude" class="form-label">Longitude</label>
                                <input type="number" class="form-control" id="longitude" step="0.0001" value="9.9217">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="priceArea" class="form-label">Electricity price area</label>
                            <select class="form-select" id="priceArea">
                                <option value="DK1" selected>DK1</option>
                                <option value="DK2">DK2</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-primary btn-lg" id="fetchDataBtn">
                    <i class="bi bi-download"></i> Fetch Data
                </button>
            </div>
        </div>
    </div>

    <!-- Data Overview -->
    <div id="dataOverview" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Period Overview</h5>
            </div>
            <div class="card-body" style="padding: 0.25rem;">
                <div id="priceChart" class="mb-4" style="width: 100%; min-width: 100%; overflow: hidden;"></div>
                <div id="co2Chart" class="mb-4" style="width: 100%; min-width: 100%; overflow: hidden;"></div>
                <div id="tempChart" style="width: 100%; min-width: 100%; overflow: hidden;"></div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted fs-5">Fetching data...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Initialize dates - default to 2 weeks back from today (if not set from server)
        const today = new Date();
        const twoWeeksAgo = new Date(today);
        twoWeeksAgo.setDate(today.getDate() - 14);
        
        // Only set if not already set from server
        if (!$('#periodStart').val()) {
            $('#periodStart').val(twoWeeksAgo.toISOString().split('T')[0]);
        }
        if (!$('#periodEnd').val()) {
            $('#periodEnd').val(today.toISOString().split('T')[0]);
        }
        if (!$('#selectedDay').val()) {
            $('#selectedDay').val(today.toISOString().split('T')[0]);
        }
        
        // Initialize map - ensure Leaflet is loaded
        function initMap() {
            console.log('Initializing map...');
            console.log('Leaflet available:', typeof L !== 'undefined');
            console.log('Map container exists:', document.getElementById('map') !== null);
            
            if (typeof L === 'undefined') {
                console.log('Leaflet library not loaded, retrying in 200ms...');
                setTimeout(initMap, 200);
                return;
            }
            
            // Check if map container exists
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Map container not found');
                setTimeout(initMap, 200);
                return;
            }
            
            // Check if map is already initialized
            if (window.emsMap) {
                console.log('Map already initialized');
                return;
            }
            
            try {
                console.log('Creating map...');
                const map = L.map('map', {
                    zoomControl: true,
                    attributionControl: true
                }).setView([57.0488, 9.9217], 7);
                
                console.log('Adding tile layer...');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Make map available globally
                window.emsMap = map;
                console.log('Map initialized successfully');
        
                // Predefined cities
                const cities = {
                    'Aalborg': {lat: 57.0488, lon: 9.9217, area: 'DK1'},
                    'Aarhus': {lat: 56.1629, lon: 10.2039, area: 'DK1'},
                    'Odense': {lat: 55.4038, lon: 10.4024, area: 'DK1'},
                    'Copenhagen': {lat: 55.6761, lon: 12.5683, area: 'DK2'}
                };
                
                const markers = {};
                
                // Add markers for predefined cities
                Object.keys(cities).forEach(city => {
                    const cityData = cities[city];
                    const marker = L.marker([cityData.lat, cityData.lon])
                        .addTo(map)
                        .bindPopup(city);
                    
                    // Add click handler to marker
                    marker.on('click', function() {
                        // Update dropdown to this city
                        $('#locationDropdown').val(city);
                        
                        // Hide custom location fields
                        $('#customLocationFields').slideUp();
                        
                        // Update latitude and longitude fields
                        $('#latitude').val(cityData.lat);
                        $('#longitude').val(cityData.lon);
                        $('#priceArea').val(cityData.area);
                        
                        // Remove custom marker if exists
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                            currentMarker = null;
                        }
                        
                        // Center map on this city
                        map.setView([cityData.lat, cityData.lon], 10);
                        marker.openPopup();
                    });
                    
                    markers[city] = marker;
                });
                
                let currentMarker = null;
                
                // Handle map clicks
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lon = e.latlng.lng;
                    
                    // Check if location is within Denmark bounds
                    // Denmark approximate bounds: lat 54.5-57.8, lon 8.0-15.0
                    const isInDenmark = lat >= 54.5 && lat <= 57.8 && lon >= 8.0 && lon <= 15.0;
                    
                    if (!isInDenmark) {
                        // Reset to Copenhagen (default city)
                        const copenhagen = cities['Copenhagen'];
                        $('#locationDropdown').val('Copenhagen');
                        $('#customLocationFields').slideUp();
                        $('#latitude').val(copenhagen.lat);
                        $('#longitude').val(copenhagen.lon);
                        $('#priceArea').val(copenhagen.area);
                        
                        // Remove custom marker if exists
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                            currentMarker = null;
                        }
                        
                        // Center map on Copenhagen
                        map.setView([copenhagen.lat, copenhagen.lon], 10);
                        if (markers['Copenhagen']) {
                            markers['Copenhagen'].openPopup();
                        }
                        
                        // Show alert message
                        showAlert('Currently only support Denmark. Location reset to Copenhagen.', 'warning');
                        return;
                    }
                    
                    // Location is in Denmark - proceed with custom location
                    // Set dropdown to Custom and show custom fields
                    $('#locationDropdown').val('Custom');
                    $('#customLocationFields').slideDown();
                    
                    // Update latitude and longitude fields
                    $('#latitude').val(lat.toFixed(4));
                    $('#longitude').val(lon.toFixed(4));
                    
                    // Update price area based on longitude
                    const area = lon > 11.5 ? 'DK2' : 'DK1';
                    $('#priceArea').val(area);
                    
                    // Update map marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    currentMarker = L.marker([lat, lon]).addTo(map).bindPopup('Custom location').openPopup();
                    map.setView([lat, lon], 10);
                });
                
                // Handle location dropdown change
                $('#locationDropdown').on('change', function() {
                    const city = $(this).val();
                    if (city === 'Custom') {
                        // Show custom location fields
                        $('#customLocationFields').slideDown();
                    } else if (cities[city]) {
                        // Hide custom location fields for predefined cities
                        $('#customLocationFields').slideUp();
                        
                        const cityData = cities[city];
                        // Update hidden values (for form submission)
                        $('#latitude').val(cityData.lat);
                        $('#longitude').val(cityData.lon);
                        $('#priceArea').val(cityData.area);
                        
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                            currentMarker = null;
                        }
                        
                        map.setView([cityData.lat, cityData.lon], 10);
                        if (markers[city]) {
                            markers[city].openPopup();
                        }
                    }
                });
                
                // Handle manual changes to latitude/longitude inputs
                $('#latitude, #longitude').on('change', function() {
                    if ($('#locationDropdown').val() === 'Custom') {
                        const lat = parseFloat($('#latitude').val());
                        const lon = parseFloat($('#longitude').val());
                        
                        if (!isNaN(lat) && !isNaN(lon)) {
                            // Update price area based on longitude
                            const area = lon > 11.5 ? 'DK2' : 'DK1';
                            $('#priceArea').val(area);
                            
                            // Update map marker
                            if (currentMarker) {
                                map.removeLayer(currentMarker);
                            }
                            currentMarker = L.marker([lat, lon]).addTo(map).bindPopup('Custom location');
                            map.setView([lat, lon], 10);
                        }
                    }
                });
                
                // Trigger invalidateSize after a short delay to ensure map renders correctly
                setTimeout(function() {
                    map.invalidateSize();
                    console.log('Map size invalidated');
                }, 300);
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }
        
        // Initialize map after page load - Leaflet should be loaded in head
        console.log('Initializing map after document ready...');
        setTimeout(function() {
            initMap();
        }, 300);
        
        // Fetch data button
        $('#fetchDataBtn').on('click', function() {
            const periodStart = $('#periodStart').val();
            const periodEnd = $('#periodEnd').val();
            const selectedDay = $('#selectedDay').val();
            const lat = parseFloat($('#latitude').val());
            const lon = parseFloat($('#longitude').val());
            const area = $('#priceArea').val();
            
            if (!periodStart || !periodEnd || !selectedDay) {
                showAlert('Please select all dates', 'warning');
                return;
            }
            
            if (periodEnd < periodStart) {
                showAlert('End date must be on or after start date', 'danger');
                return;
            }
            
            $('#loadingSpinner').show();
            $('#dataOverview').hide();
            $('#fetchDataBtn').prop('disabled', true);
            
            // Fetch data sequentially to avoid session race conditions
            fetchPriceData(periodStart, periodEnd, selectedDay, area)
            .then(function(priceData) {
                return fetchCO2Data(periodStart, periodEnd, selectedDay, area).then(function(co2Data) {
                    return fetchWeatherData(periodStart, periodEnd, selectedDay, lat, lon).then(function(weatherData) {
                        return [priceData, co2Data, weatherData];
                    });
                });
            })
            .then(function(results) {
                const [priceData, co2Data, weatherData] = results;
                
                // Render charts
                if (priceData && priceData.success) {
                    renderPriceChart(priceData.period_data, priceData.selected_day_data, selectedDay);
                    if (priceData.note) {
                        $('#priceChart').after('<div class="mt-2"><small class="text-muted">ℹ️ ' + priceData.note + '</small></div>');
                    }
                }
                
                if (co2Data && co2Data.success) {
                    renderCO2Chart(co2Data.period_data, co2Data.selected_day_data, selectedDay);
                    if (co2Data.note) {
                        $('#co2Chart').after('<div class="mt-2"><small class="text-muted">ℹ️ ' + co2Data.note + '</small></div>');
                    }
                }
                
                if (weatherData && weatherData.success) {
                    renderTempChart(weatherData.period_data, weatherData.selected_day_data, selectedDay);
                    if (weatherData.note) {
                        $('#tempChart').after('<div class="mt-2"><small class="text-muted">ℹ️ ' + weatherData.note + '</small></div>');
                    }
                }
                
                $('#loadingSpinner').hide();
                $('#dataOverview').show();
                $('#fetchDataBtn').prop('disabled', false);
                
                // Force charts to resize after showing
                setTimeout(function() {
                    if (typeof Plotly !== 'undefined') {
                        Plotly.Plots.resize('priceChart');
                        Plotly.Plots.resize('co2Chart');
                        Plotly.Plots.resize('tempChart');
                    }
                }, 100);
                
                showAlert('Data fetched successfully!', 'success');
            }).catch(function(error) {
                console.error('Error fetching data:', error);
                $('#loadingSpinner').hide();
                $('#fetchDataBtn').prop('disabled', false);
                showAlert('Error fetching data: ' + error.message, 'danger');
            });
        });
        
        function fetchPriceData(periodStart, periodEnd, selectedDay, area) {
            console.log('Fetching price data...');
            return $.ajax({
                url: '/api/fetch-price-data',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    period_start: periodStart,
                    period_end: periodEnd,
                    selected_day: selectedDay,
                    area: area
                })
            }).then(function(response) {
                console.log('Price data response:', response);
                if (response.success) {
                    return response;
                } else {
                    throw new Error(response.error || 'Failed to fetch price data');
                }
            }).catch(function(xhr) {
                console.error('Price data error:', xhr);
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to fetch price data';
                throw new Error(errorMsg);
            });
        }
        
        function fetchCO2Data(periodStart, periodEnd, selectedDay, area) {
            console.log('Fetching CO2 data...');
            return $.ajax({
                url: '/api/fetch-co2-data',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    period_start: periodStart,
                    period_end: periodEnd,
                    selected_day: selectedDay,
                    area: area
                })
            }).then(function(response) {
                console.log('CO2 data response:', response);
                if (response.success) {
                    return response;
                } else {
                    throw new Error(response.error || 'Failed to fetch CO2 data');
                }
            }).catch(function(xhr) {
                console.error('CO2 data error:', xhr);
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to fetch CO2 data';
                throw new Error(errorMsg);
            });
        }
        
        function fetchWeatherData(periodStart, periodEnd, selectedDay, lat, lon) {
            console.log('Fetching weather data...');
            return $.ajax({
                url: '/api/fetch-weather',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    period_start: periodStart,
                    period_end: periodEnd,
                    selected_day: selectedDay
                })
            }).then(function(response) {
                console.log('Weather data response:', response);
                if (response.success) {
                    return response;
                } else {
                    throw new Error(response.error || 'Failed to fetch weather data');
                }
            }).catch(function(xhr) {
                console.error('Weather data error:', xhr);
                const errorMsg = xhr.responseJSON?.error || xhr.statusText || 'Failed to fetch weather data';
                throw new Error(errorMsg);
            });
        }

        // Chart rendering functions
        function renderPriceChart(periodData, selectedDayData, selectedDay) {
            if (!periodData || !periodData.index || !periodData.values) {
                console.warn('Invalid price data');
                return;
            }
            
            const periodDates = periodData.index.map(d => new Date(d));
            const periodValues = periodData.values;
            
            // Find selected day data
            const selectedDate = new Date(selectedDay);
            const selectedDates = [];
            const selectedValues = [];
            
            periodData.index.forEach((dateStr, idx) => {
                const date = new Date(dateStr);
                if (date.toDateString() === selectedDate.toDateString()) {
                    selectedDates.push(date);
                    selectedValues.push(periodValues[idx]);
                }
            });
            
            const trace1 = {
                x: periodDates,
                y: periodValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Full period',
                line: {color: 'rgba(100,100,100,0.7)', width: 1}
            };
            
            const data = [trace1];
            
            if (selectedDates.length > 0) {
                const trace2 = {
                    x: selectedDates,
                    y: selectedValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Selected day',
                    line: {color: 'crimson', width: 3}
                };
                data.push(trace2);
            }
            
            const layout = {
                title: 'Electricity price over selected period',
                xaxis: {title: 'Time'},
                yaxis: {title: 'DKK/kWh'},
                hovermode: 'x unified',
                height: 400,
                margin: {l: 60, r: 0, t: 40, b: 60, pad: 0},
                autosize: true,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                width: null
            };
            
            const priceChartDiv = document.getElementById('priceChart');
            if (priceChartDiv) {
                priceChartDiv.style.width = '100%';
                Plotly.newPlot('priceChart', data, layout, {responsive: true, displayModeBar: false, useResizeHandler: true}).then(function() {
                    setTimeout(function() {
                        Plotly.Plots.resize('priceChart');
                    }, 50);
                });
            }
        }
        
        function renderCO2Chart(periodData, selectedDayData, selectedDay) {
            if (!periodData || !periodData.index || !periodData.values) {
                console.warn('Invalid CO2 data');
                return;
            }
            
            const periodDates = periodData.index.map(d => new Date(d));
            const periodValues = periodData.values;
            
            const selectedDate = new Date(selectedDay);
            const selectedDates = [];
            const selectedValues = [];
            
            periodData.index.forEach((dateStr, idx) => {
                const date = new Date(dateStr);
                if (date.toDateString() === selectedDate.toDateString()) {
                    selectedDates.push(date);
                    selectedValues.push(periodValues[idx]);
                }
            });
            
            // Calculate bar width (assuming minute data)
            const barWidth = 60000; // 1 minute in milliseconds
            
            const trace1 = {
                x: periodDates,
                y: periodValues,
                type: 'bar',
                name: 'Full period',
                marker: {color: 'lightgray'},
                opacity: 0.8,
                width: barWidth
            };
            
            const data = [trace1];
            
            if (selectedDates.length > 0) {
                const trace2 = {
                    x: selectedDates,
                    y: selectedValues,
                    type: 'bar',
                    name: 'Selected day',
                    marker: {color: 'crimson'},
                    opacity: 1.0,
                    width: barWidth
                };
                data.push(trace2);
            }
            
            const layout = {
                title: 'CO₂ intensity over selected period',
                xaxis: {title: 'Time'},
                yaxis: {title: 'gCO₂/kWh'},
                barmode: 'overlay',
                hovermode: 'x unified',
                height: 400,
                margin: {l: 60, r: 0, t: 40, b: 60, pad: 0},
                autosize: true,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                width: null
            };
            
            const co2ChartDiv = document.getElementById('co2Chart');
            if (co2ChartDiv) {
                co2ChartDiv.style.width = '100%';
                Plotly.newPlot('co2Chart', data, layout, {responsive: true, displayModeBar: false, useResizeHandler: true}).then(function() {
                    setTimeout(function() {
                        Plotly.Plots.resize('co2Chart');
                    }, 50);
                });
            }
        }
        
        function renderTempChart(periodData, selectedDayData, selectedDay) {
            if (!periodData || !periodData.index || !periodData.values) {
                console.warn('Invalid temperature data');
                return;
            }
            
            const periodDates = periodData.index.map(d => new Date(d));
            const periodValues = periodData.values;
            
            const selectedDate = new Date(selectedDay);
            const selectedDates = [];
            const selectedValues = [];
            
            periodData.index.forEach((dateStr, idx) => {
                const date = new Date(dateStr);
                if (date.toDateString() === selectedDate.toDateString()) {
                    selectedDates.push(date);
                    selectedValues.push(periodValues[idx]);
                }
            });
            
            const trace1 = {
                x: periodDates,
                y: periodValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Full period',
                line: {color: 'rgba(100,100,100,0.7)', width: 1}
            };
            
            const data = [trace1];
            
            if (selectedDates.length > 0) {
                const trace2 = {
                    x: selectedDates,
                    y: selectedValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Selected day',
                    line: {color: 'crimson', width: 3}
                };
                data.push(trace2);
            }
            
            const layout = {
                title: 'Outdoor temperature over selected period',
                xaxis: {title: 'Time'},
                yaxis: {title: '°C'},
                hovermode: 'x unified',
                height: 400,
                margin: {l: 60, r: 0, t: 40, b: 60, pad: 0},
                autosize: true,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                width: null
            };
            
            const tempChartDiv = document.getElementById('tempChart');
            if (tempChartDiv) {
                tempChartDiv.style.width = '100%';
                Plotly.newPlot('tempChart', data, layout, {responsive: true, displayModeBar: false, useResizeHandler: true}).then(function() {
                    setTimeout(function() {
                        Plotly.Plots.resize('tempChart');
                    }, 50);
                });
            }
        }

        function showAlert(message, type) {
            const alert = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            $('main').prepend(alert);
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 3000);
        }
    });
</script>
{% endblock %}
