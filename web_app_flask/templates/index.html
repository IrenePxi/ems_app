<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Web Application</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 1.5rem; }
        .nav-links { display: flex; gap: 1rem; }
        .nav-link {
            padding: 0.5rem 1rem;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .hidden { display: none; }
        .success { background: #efe; color: #3c3; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
        .error { background: #fee; color: #c33; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Daily EMS Sandbox</h1>
        <div class="nav-links">
            <a href="#" class="nav-link active" onclick="showPage('scenario')">1Ô∏è‚É£ Scenario</a>
            <a href="#" class="nav-link" onclick="showPage('devices')">2Ô∏è‚É£ Devices</a>
            <a href="#" class="nav-link" onclick="showPage('analysis')">3Ô∏è‚É£ Analysis</a>
        </div>
    </nav>

    <div class="container">
        <!-- Scenario Page -->
        <div id="scenario-page" class="card">
            <h2>1Ô∏è‚É£ Scenario & Data</h2>
            <div class="form-group">
                <label>Selected Day</label>
                <input type="date" id="selected-day" value="">
            </div>
            <div class="form-group">
                <label>Location</label>
                <select id="location-select" onchange="updateLocation()">
                    <option value="Aalborg (DK1)">Aalborg (DK1)</option>
                    <option value="Aarhus (DK1)">Aarhus (DK1)</option>
                    <option value="Copenhagen (DK2)">Copenhagen (DK2)</option>
                </select>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Latitude</label>
                    <input type="number" id="lat" step="0.0001" value="57.0488">
                </div>
                <div class="form-group">
                    <label>Longitude</label>
                    <input type="number" id="lon" step="0.0001" value="9.9217">
                </div>
            </div>
            <div class="form-group">
                <label>Price Area</label>
                <select id="area">
                    <option value="DK1">DK1</option>
                    <option value="DK2">DK2</option>
                </select>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Period Start</label>
                    <input type="date" id="period-start">
                </div>
                <div class="form-group">
                    <label>Period End</label>
                    <input type="date" id="period-end">
                </div>
            </div>
            <button class="btn" onclick="fetchData()">üì• Fetch Data</button>
            <div id="scenario-message"></div>
        </div>

        <!-- Devices Page -->
        <div id="devices-page" class="card hidden">
            <h2>2Ô∏è‚É£ Devices & Layout</h2>
            <div class="form-group">
                <label>House Size</label>
                <select id="house-size">
                    <option value="Small apartment">Small apartment</option>
                    <option value="Medium house" selected>Medium house</option>
                    <option value="Large house">Large house</option>
                </select>
            </div>
            <div class="form-group">
                <label>Number of Residents</label>
                <input type="number" id="residents" min="1" max="8" value="2">
            </div>
            <button class="btn" onclick="calculateLoad()">Calculate Load Profile</button>
            <div id="devices-message"></div>
        </div>

        <!-- Analysis Page -->
        <div id="analysis-page" class="card hidden">
            <h2>3Ô∏è‚É£ Analysis</h2>
            <div class="grid">
                <div class="form-group">
                    <label>Battery Capacity (kWh)</label>
                    <input type="number" id="batt-cap" step="0.5" value="70">
                </div>
                <div class="form-group">
                    <label>Battery Power (kW)</label>
                    <input type="number" id="batt-pow" step="0.5" value="9">
                </div>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Initial SOC (%)</label>
                    <input type="number" id="soc-init" min="0" max="100" value="50">
                </div>
                <div class="form-group">
                    <label>Min SOC (%)</label>
                    <input type="number" id="soc-min" min="0" max="100" value="15">
                </div>
            </div>
            <button class="btn" onclick="runEMS()">Run EMS</button>
            <div id="analysis-message"></div>
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Set default dates
        document.getElementById('selected-day').value = new Date().toISOString().split('T')[0];
        const endDate = new Date();
        const startDate = new Date(endDate.getTime() - 15 * 24 * 60 * 60 * 1000);
        document.getElementById('period-start').value = startDate.toISOString().split('T')[0];
        document.getElementById('period-end').value = endDate.toISOString().split('T')[0];

        const locations = {
            'Aalborg (DK1)': {lat: 57.0488, lon: 9.9217, area: 'DK1'},
            'Aarhus (DK1)': {lat: 56.1629, lon: 10.2039, area: 'DK1'},
            'Copenhagen (DK2)': {lat: 55.6761, lon: 12.5683, area: 'DK2'}
        };

        function updateLocation() {
            const sel = document.getElementById('location-select');
            const loc = locations[sel.value];
            document.getElementById('lat').value = loc.lat;
            document.getElementById('lon').value = loc.lon;
            document.getElementById('area').value = loc.area;
        }

        function showPage(page) {
            document.querySelectorAll('[id$="-page"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function fetchData() {
            const msg = document.getElementById('scenario-message');
            msg.innerHTML = '<div class="success">Fetching data...</div>';
            
            try {
                const start = document.getElementById('period-start').value;
                const end = document.getElementById('period-end').value;
                const area = document.getElementById('area').value;
                const lat = document.getElementById('lat').value;
                const lon = document.getElementById('lon').value;

                const [price, co2, weather] = await Promise.all([
                    fetch(`/api/data/price?start_date=${start}&end_date=${end}&area=${area}`).then(r => r.json()),
                    fetch(`/api/data/co2?start_date=${start}&end_date=${end}&area=${area}`).then(r => r.json()),
                    fetch(`/api/data/weather?lat=${lat}&lon=${lon}&start_date=${start}&end_date=${end}`).then(r => r.json())
                ]);

                localStorage.setItem('ems_data', JSON.stringify({price, co2, weather, lat, lon, area}));
                msg.innerHTML = '<div class="success">Data fetched successfully!</div>';
            } catch (e) {
                msg.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function calculateLoad() {
            const msg = document.getElementById('devices-message');
            msg.innerHTML = '<div class="success">Calculating...</div>';
            
            try {
                const data = JSON.parse(localStorage.getItem('ems_data'));
                if (!data) throw new Error('Please fetch data first!');

                const response = await fetch('/api/devices/calculate-load', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        devices: [{type: 'heat_pump', name: 'HP1', params: {}}],
                        start_date: document.getElementById('period-start').value,
                        end_date: document.getElementById('period-end').value,
                        outdoor_temp: data.weather
                    })
                });

                const result = await response.json();
                localStorage.setItem('ems_load', JSON.stringify(result));
                msg.innerHTML = '<div class="success">Load profile calculated!</div>';
            } catch (e) {
                msg.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function runEMS() {
            const msg = document.getElementById('analysis-message');
            msg.innerHTML = '<div class="success">Running EMS...</div>';
            
            try {
                const load = JSON.parse(localStorage.getItem('ems_load'));
                if (!load) throw new Error('Please calculate load profile first!');

                const response = await fetch('/api/ems/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        load_kw: load.total_load_kw,
                        pv_kw: {data: new Array(Object.keys(load.total_load_kw).length).fill(0), index: load.index},
                        plan_slots: [
                            {start: '00:00', end: '06:00', soc_setpoint_pct: 15, grid_charge_allowed: 0},
                            {start: '06:00', end: '10:00', soc_setpoint_pct: 60, grid_charge_allowed: 0},
                            {start: '10:00', end: '14:00', soc_setpoint_pct: 80, grid_charge_allowed: 0},
                            {start: '14:00', end: '18:00', soc_setpoint_pct: 100, grid_charge_allowed: 0},
                            {start: '18:00', end: '20:00', soc_setpoint_pct: 50, grid_charge_allowed: 0},
                            {start: '20:00', end: '23:59', soc_setpoint_pct: 15, grid_charge_allowed: 0}
                        ],
                        battery_config: {
                            capacity_kwh: parseFloat(document.getElementById('batt-cap').value),
                            power_kw: parseFloat(document.getElementById('batt-pow').value),
                            soc_init_pct: parseFloat(document.getElementById('soc-init').value),
                            soc_min_pct: parseFloat(document.getElementById('soc-min').value)
                        },
                        energy_pattern: 2
                    })
                });

                const result = await response.json();
                displayResults(result);
                msg.innerHTML = '<div class="success">EMS completed!</div>';
            } catch (e) {
                msg.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        function displayResults(result) {
            const div = document.getElementById('results');
            div.innerHTML = `
                <h3>Results</h3>
                <p>Self-Consumption: ${result.kpis.self_consumption_pct.toFixed(1)}%</p>
                <p>Self-Sufficiency: ${result.kpis.self_sufficiency_pct.toFixed(1)}%</p>
                <div id="plot"></div>
            `;
            
            Plotly.newPlot('plot', [{
                x: result.index,
                y: Object.values(result.grid_import_kw),
                type: 'scatter',
                mode: 'lines',
                name: 'Grid Import'
            }], {title: 'Power Flow'});
        }
    </script>
</body>
</html>
